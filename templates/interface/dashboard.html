{% extends "interface/base.html" %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container">
    <h1 class="dashboard-title mb-3">Tableau de Bord - Surveillance des Débordements</h1>

    <!-- Statistiques principales -->
    <div class="stats-grid mb-3" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px;">
        <div class="card alert-success text-center">
            <span style="font-size: 2.2rem;">{{ total_images }}</span><br>
            <small>Total Images</small>
        </div>
        <div class="card alert text-center">
            <span style="font-size: 2.2rem;">{{ images_pleines }}</span><br>
            <small>Images Pleines</small>
        </div>
        <div class="card alert-error text-center">
            <span style="font-size: 2.2rem;">{{ images_vides }}</span><br>
            <small>Images Vides</small>
        </div>
        <div class="card text-center" style="background: var(--blue); color: #fff;">
            <span style="font-size: 2.2rem;">{{ images_non_annotees }}</span><br>
            <small>Non Annotées</small>
        </div>
    </div>

    <!-- matplotlib -->
    <div class="card mb-3 text-center">
        <h2>Graphique statique </h2>
        <img src="{% url 'graphique_statique' %}" alt="Graphique des annotations" style="max-width: 400px;" class="my-3">
    </div>

    <!-- Chart.js -->
    <div class="card mb-3">
        <h2>Graphique dynamique</h2>
        <canvas id="chartAnnotations" height="180"></canvas>
    </div>

    <!-- Répartition des annotations -->
    <div class="card mb-3">
        <h2>Répartition des Annotations</h2>
        <div style="background: var(--blue); border-radius: 12px; height: 22px; width: 100%; position: relative; overflow: hidden;">
            <div style="background: var(--green); width: {{ pourcentage_pleines }}%; height: 100%; border-radius: 12px 0 0 12px; float: left;"></div>
            <div style="background: var(--orange); width: {{ pourcentage_vides }}%; height: 100%; float: left;"></div>
            <div style="background: var(--yellow); width: {{ pourcentage_non_annotees }}%; height: 100%; float: left; border-radius: 0 12px 12px 0;"></div>
            <span style="position: absolute; left: 10px; top: 2px; color: #fff; font-weight: 600;">{{ pourcentage_pleines }}% Pleines</span>
            <span style="position: absolute; right: 10px; top: 2px; color: #fff; font-weight: 600;">{{ pourcentage_vides }}% Vides</span>
        </div>
    </div>

    <!-- Distribution des tailles -->
    <div class="card mb-3">
        <h2>Distribution des Tailles</h2>
        <div style="display: flex; gap: 24px; flex-wrap: wrap;">
            <div class="card text-center" style="flex: 1;">
                <strong>{{ taille_moyenne|default:"N/A" }}</strong><br><span>Moyenne (MB)</span>
            </div>
            <div class="card text-center" style="flex: 1;">
                <strong>{{ taille_totale|default:"N/A" }}</strong><br><span>Total (MB)</span>
            </div>
            <div class="card text-center" style="flex: 1;">
                <strong>{{ taille_max|default:"N/A" }}</strong><br><span>Plus grande (MB)</span>
            </div>
            <div class="card text-center" style="flex: 1;">
                <strong>{{ taille_min|default:"N/A" }}</strong><br><span>Plus petite (MB)</span>
            </div>
        </div>
    </div>

    <!-- Cartographie des zones à risque -->
    <div class="card mb-3">
        <h2>Cartographie des Zones à Risque</h2>
        <div id="mapid" style="height: 400px; border-radius: 18px; overflow: hidden;"></div>
        <div style="display: flex; gap: 24px; margin-top: 18px;">
            <div class="card text-center" style="flex: 1;">
                <strong style="color: var(--orange);">{{ zones_critiques|default:"0" }}</strong><br>
                <span>Zones Critiques</span>
            </div>
            <div class="card text-center" style="flex: 1;">
                <strong style="color: var(--yellow);">{{ zones_surveillees|default:"0" }}</strong><br>
                <span>Zones Surveillées</span>
            </div>
            <div class="card text-center" style="flex: 1;">
                <strong style="color: var(--green);">{{ zones_sures|default:"0" }}</strong><br>
                <span>Zones Sûres</span>
            </div>
        </div>
    </div>

    <!-- Tableau des images récentes -->
    <div class="card mb-3">
        <h2>Images Récentes</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Date</th>
                    <th>Annotation</th>
                    <th>Taille</th>
                    <th>Localisation</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for image in images %}
                <tr>
                    <td>{{ image.id }}</td>
                    <td>{{ image.date_ajout|date:"d/m/Y H:i"|default:"N/A" }}</td>
                    <td>
                        {% if image.annotation == 'pleine' %}
                        <span class="alert-success rounded p-2">Pleine</span>
                        {% elif image.annotation == 'vide' %}
                        <span class="alert-error rounded p-2">Vide</span>
                        {% else %}
                        <span class="alert rounded p-2">Non annotée</span>
                        {% endif %}
                    </td>
                    <td>{{ image.taille_fichier|floatformat:2|default:"N/A" }} MB</td>
                    <td>
                        {% if image.latitude and image.longitude %}
                        {{ image.latitude|floatformat:4 }}, {{ image.longitude|floatformat:4 }}
                        {% else %} Non géolocalisée {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'annoter_image' image.id %}" class="btn btn-green btn-sm">Annoter</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination">
            {% if images.has_previous %}
            <a href="?page={{ images.previous_page_number }}" class="btn btn-sm">← Précédent</a>
            {% endif %}
            <span>Page {{ images.number }} / {{ images.paginator.num_pages }}</span>
            {% if images.has_next %}
            <a href="?page={{ images.next_page_number }}" class="btn btn-sm">Suivant →</a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Leaflet
        const coords = JSON.parse('{{ coords_json|escapejs }}');
        const defaultLatLng = coords.length ? [coords[0].lat, coords[0].lng] : [48.8566, 2.3522];
        const map = L.map('mapid').setView(defaultLatLng, 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap',
            maxZoom: 19,
        }).addTo(map);

        const greenIcon = new L.Icon({
            iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green.png',
            shadowUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/msmarker.shadow.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32],
            shadowSize: [59, 32],
            shadowAnchor: [16, 32]
        });

        const redIcon = new L.Icon({
            iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red.png',
            shadowUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/msmarker.shadow.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32],
            shadowSize: [59, 32],
            shadowAnchor: [16, 32]
        });

        coords.forEach(point => {
            let icon = greenIcon;
            if (point.annotation === "pleine") icon = redIcon;
            const marker = L.marker([point.lat, point.lng], { icon: icon }).addTo(map);
            marker.bindPopup(`<strong>ID:</strong> ${point.id}<br><strong>Annotation:</strong> ${point.annotation}<br><strong>Date:</strong> ${point.date}`);
        });

        // Chart.js dynamique
        const stats = {{ stats_annotation|safe }};
        const ctx = document.getElementById('chartAnnotations').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Pleines', 'Vides', 'Non annotées'],
                datasets: [{
                    label: 'Nombre d’images',
                    data: [stats.pleines, stats.vides, stats.non_annotees],
                    backgroundColor: ['#ff6b6b', '#4ecdc4', '#ffa726'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, precision: 0 }
                }
            }
        });

        // Auto-refresh
        setTimeout(() => location.reload(), 300000);
    });
</script>
{% endblock %}
